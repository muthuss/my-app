<!DOCTYPE HTML>
<html>
  <head>
  	<style type="text/css">
  	html, body, #chartdiv {
  		padding:0;
  		margin: 0;
  		height: 100%;
  	}
 	#autoRefreshBtn {
 		position: absolute;
 		top: 5px;
 		left: 5px;
 	}
  	</style>
	<script type="text/javascript" src="phonegap.0.9.5.js""></script>
	<script type="text/javascript" src="FusionCharts.js"></script>
	<script type="text/javascript" src="calllog.phonegap.js" ></script>
	<script type="text/javascript"><!--
		var debug = { log:function(x) { document.getElementById("db").value += x +"\n"; }, getKeys: function(x) { var r=[]; for(var i in x) {r.push(i);}  return r;} };

		function preinit() { 
		
			//document.addEventListener("backbutton", backbuttoncallback, false);
			document.addEventListener("searchbutton", searchbuttoncallback, false);
			document.addEventListener("menubutton", menubuttoncallback, false);
			//document.addEventListener("pause", apppausecallback, false);
			//document.addEventListener("resume", appresumecallback, false);
			document.addEventListener("deviceready", init, true); 
		
		}

		var firstLoad = true;
		var autoRefresh= true;
		var callCounterOld="";
		var autoTimer;
		
		function init(){
			autoRefresh = !autoRefresh;
			document.getElementById("autoRefreshBtn").value=autoRefresh? "Stop  Auto Refresh":"Start Auto Refresh";
			if(firstLoad)
			{ 
				window.setTimeout(function() { window.plugins.calllog.all("all",successCallback, failureCallback); }, 0);
			}
				
			if (autoRefresh) 
			{
				autoTimer = window.setInterval(function (){window.plugins.calllog.all("all",successCallback, failureCallback);} , 10000);
			}
			else
			{
				window.clearInterval(autoTimer);
			}
		}
 		
 		var backbuttoncallback = function(params)
 		{
 		
 		}
 		var searchbuttoncallback = function(params)
 		{
 		
 		}
 		var menubuttoncallback = function(params)
 		{
 		
 		}
 		var apppausecallback = function(params)
 		{
 		
 		}
 		var appresumecallback = function(params)
 		{
 		
 		}
 		
		var successCallback = function(result){ 
 			  
 			  
 		/* DATE (long-integer)
		 * NUMBER (text)
		 * TYPE[1- INCOMING_TYPE,3- MISSED_TYPE,2- OUTGOING_TYPE] (int-INTEGER)
		 * DURATION (long-INTEGER)
		 * NEW (boolean-INTEGER)
		 * CACHED_NAME (text)
		 * CACHED_NUMBER_TYPE (integer)
		 * CACHED_NUMBER_LABEL(text)
		 */
 			  
 			  
 			  var callCounter= [[0,0],[0,0],[0,0]];
 			  var rows = result.Rows;
 			  
 			  for(var i in rows)
 			  {
 			  	callCounter[rows[i][2]-1][0]++;
 			  	callCounter[rows[i][2]-1][1]+=rows[i][3];
 			  }
 		  	  
 		  	  if(isOld(callCounter)){
 		  	  	return;
 		  	  }
 		  	  
 			  
 			  var callLogChartData = "<chart caption='Total of "+rows.length+" calls    ' "+(firstLoad?"":" animation='0' ")+" manageLabelOverflow='1' showLegend='1' baseFontSize='20'>";
 			  callLogChartData +="<set value='"+callCounter[0][0]+"' label='Incoming calls  ' />";
 			  callLogChartData +="<set value='"+callCounter[1][0]+"' label='Outgoing calls  ' />";
 			  callLogChartData +="<set value='"+callCounter[2][0]+"' label='Missed calls  ' />";
 			  callLogChartData +="</chart>";
 			  
 			  
	            
            if(FusionCharts("ChartId"))
            {
            	//alert("updating chart");
            	FusionCharts("ChartId").setXMLData(callLogChartData);
            	//if (FusionCharts("ChartId")) FusionCharts("ChartId").dispose();
            	//var chart = new FusionCharts("Column2D", "ChartId", "100%", "100%");
            	//chart.setXMLData(callLogChartData);
            	//chart.render("chartdiv");
            }
            else
            {
            	//alert("creating new chart");
            	var chart = new FusionCharts("Pie2D", "ChartId", "100%", "100%");
            	chart.setXMLData(callLogChartData);
            	chart.render("chartdiv");
            }

		
 			  
 			  if(firstLoad){ 
	 			  firstLoad=false;
	 		  	  init();
	 		  }
 			  
 			  
 			  
 			  //debug.log(new Date(rows[0][0]));
    		  //debug.log(JSON.stringify(callCounter));
 			  //debug.log(" --- ########");
		}
		   
		var failureCallback = function(error){
 			  alert("Error: " +result);
    		  //debug.log(result);
 			  //debug.log("-- !!!!!!!!!!!!");
  		}
		
		
		function isOld(arr1)
		{
			if(!arr1) 
			{
				return false;
			}
			
			var strArr1="";
			
			for(var i=0;i<arr1.length;i++)
			{
				strArr1+= arr1[i].join(""); 
			}
			
			var isOldData = (strArr1==callCounterOld);
			callCounterOld = strArr1;
			 
			return isOldData;		
		}
	
		// -->
	</script>
	
	
  </head>
  <body onload="preinit();" style="height:100%;">
      <!-- <textarea rows='5' cols='50' id="db" ></textarea> -->
      
      <div id="chartdiv" align="center" style="visibility:visible !important;style="height:100%;"">Call Log counter using FusionCharts<br>The chart will show the number of incoming, outgoing and missed calls.</div>
      <input id="autoRefreshBtn" type="button" value="Stop Auto Refresh" onclick="init();"/>
      
      <script type="text/javascript"><!--
      	
      
 
	
        // -->
       </script>
  
   </body>
</html>
